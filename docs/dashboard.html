<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - HeartSpeak</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg-body, #ffe6f0);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 1rem;
    }
    header {
      text-align: center;
      margin-bottom: 1rem;
    }
    .logo {
      height: 80px;
      max-width: 100%;
    }
    main.dashboard-container {
      position: relative;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 0 40px #ffe7f7cc, 0 2px 18px #c88ad433;
      animation: dashGlow 2.6s ease-in-out infinite alternate;
      padding: 2rem;
      max-width: 420px;
      width: 100%;
      text-align: center;
      margin-bottom: 2.5rem;
    }
    @keyframes dashGlow {
      0% { box-shadow: 0 0 40px #ffe7f7cc, 0 2px 18px #c88ad433; }
      100% { box-shadow: 0 0 90px #fbb5dd66, 0 2px 32px #b250c355; }
    }
    h1 {
      margin-bottom: 1.2rem;
      color: #cc0066;
    }
    #userInfo {
      margin-bottom: 1.1rem;
      color: #6a227c;
      font-size: 1.04rem;
      font-weight: 500;
    }
    nav ul {
      list-style: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 0;
    }
    nav a {
      display: block;
      padding: 0.75rem 1rem;
      background: #ff4081;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s ease;
    }
    nav a:hover {
      background: #e73370;
    }
    #logoutBtn {
      margin-top: 2rem;
      background: linear-gradient(90deg,#ff4081,#b250c3 90%);
      color: white;
      border: none;
      border-radius: 1rem;
      padding: 0.8rem 2.5rem;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 12px #b250c333;
      transition: background 0.2s;
    }
    #logoutBtn:hover {
      background: linear-gradient(90deg,#b250c3,#ff4081 90%);
    }
    /* Card Stats */
    .stat-box {
      background: #fdf1fa;
      color: #b250c3;
      border-radius: 12px;
      padding: 0.85rem 0.9rem;
      margin: 0.7rem 0 1.2rem 0;
      box-shadow: 0 2px 14px #ffe7f799;
      font-size: 1.12rem;
      font-weight: 600;
    }
    /* Recent Activity */
    .activity-list {
      background: #f8f5ff;
      border-radius: 12px;
      padding: 1rem;
      margin: 0.4rem 0 1.3rem 0;
      box-shadow: 0 2px 10px #b4aad611;
      font-size: 1.01rem;
      text-align: left;
      max-height: 160px;
      overflow-y: auto;
    }
    .activity-list h3 {
      margin: 0 0 0.6rem 0;
      color: #b250c3;
      font-size: 1.07rem;
      font-weight: 700;
      text-align: center;
    }
    .activity-list ul {
      list-style: disc inside;
      margin: 0;
      padding-left: 12px;
    }
    .activity-list li {
      margin-bottom: 0.3rem;
      font-size: 0.99rem;
      color: #4c316a;
    }
  </style>
</head>
<body>
  <header>
    <img src="img/logo.png" alt="HeartSpeak Logo" class="logo" />
  </header>
  <main class="dashboard-container">
    <h1>Welcome to Your Dashboard</h1>
    <div id="userInfo"></div>
    <div class="stat-box" id="cardStats">Loading your stats…</div>
    <div class="activity-list">
      <h3>Recent Activity</h3>
      <ul id="recentActivity">
        <li>Loading…</li>
      </ul>
    </div>
    <nav>
      <ul>
        <li><a href="card-creator.html">Create Card</a></li>
        <li><a href="analytics-dashboard.html">View Analytics</a></li>
        <li><a href="preview.html">Preview Dedication</a></li>
        <li><a href="share-settings.html">Share Settings</a></li>
        <li><a href="template-gallery.html">Template Gallery</a></li>
      </ul>
    </nav>
    <button id="logoutBtn">Logout</button>
  </main>

  <!-- Firebase SDKs (Auth + Firestore) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.firebasestorage.app",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7",
      measurementId: "G-RGVFVSSPMG"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Show user info & protect dashboard
    let currentUID = null;
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUID = user.uid;
        let name = user.email;
        try {
          const doc = await db.collection("users").doc(user.uid).get();
          if (doc.exists && doc.data().username) {
            name = doc.data().username + " (" + user.email + ")";
          }
        } catch (e) { /* ignore if users collection not found */ }
        document.getElementById('userInfo').textContent = `Logged in as: ${name}`;
        loadCardStats();
        loadRecentActivity();
      }
    });

    // Logout functionality
    document.getElementById('logoutBtn').onclick = function() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    };

    // --------- Dashboard stats and recent activity ---------
    // Cards should be saved in Firestore with at least: {uid, wish, createdAt, ...}
    async function loadCardStats() {
      if (!currentUID) return;
      const snap = await db.collection("cards").where("uid", "==", currentUID).get();
      document.getElementById('cardStats').textContent =
        `You’ve created ${snap.size} ${snap.size===1?"card":"cards"} so far!`;
    }

    async function loadRecentActivity() {
      if (!currentUID) return;
      const ul = document.getElementById('recentActivity');
      const snap = await db.collection("cards")
        .where("uid", "==", currentUID)
        .orderBy("createdAt", "desc")
        .limit(5)
        .get();
      ul.innerHTML = "";
      if (snap.empty) {
        ul.innerHTML = "<li>No cards sent yet.</li>";
        return;
      }
      snap.forEach(doc => {
        const data = doc.data();
        let dt = data.createdAt?.toDate ? data.createdAt.toDate() : null;
        let dateStr = dt ? dt.toLocaleString() : "recently";
        let wish = (data.wish || data.level2Message || "Card Sent");
        if(wish.length > 35) wish = wish.slice(0,35) + "...";
        ul.innerHTML += `<li><b>${wish}</b><br><small style="color:#b250c3;">${dateStr}</small></li>`;
      });
    }
  </script>
</body>
</html>
