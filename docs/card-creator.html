<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create a Card | HeartSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: linear-gradient(135deg, #fff1f7 0%, #c1d8ff 100%);
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 420px;
      margin: 32px auto;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 10px 28px rgba(180, 85, 250, 0.10), 0 2px 4px rgba(0,0,0,0.02);
      padding: 32px 28px;
      text-align: center;
    }
    .container h2 {
      margin-bottom: 20px;
      color: #f64e8b;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
      color: #555;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #eee;
      border-radius: 8px;
      font-size: 15px;
      background: #f6f6ff;
      margin-bottom: 8px;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 52px;
      max-height: 120px;
    }
    .stickers, .backgrounds {
      display: flex;
      gap: 12px;
      margin: 10px 0;
    }
    .sticker-btn {
      background: #ffe4f5;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      padding: 6px 10px;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .sticker-btn.selected {
      box-shadow: 0 0 0 3px #f64e8b55;
    }
    .background-btn {
      padding: 7px 18px;
      border-radius: 10px;
      border: 1px solid #eee;
      cursor: pointer;
      background: #e0eaff;
      color: #222;
      transition: background 0.2s;
    }
    .background-btn.selected {
      background: #f64e8b;
      color: #fff;
      border: 1px solid #f64e8b;
    }
    .photo-upload {
      background: #f9f9ff;
      padding: 14px;
      border-radius: 12px;
      border: 1px dashed #ccc;
      margin: 15px 0 25px;
      font-size: 15px;
    }
    .btn-primary {
      width: 100%;
      background: linear-gradient(90deg, #f64e8b, #a980ee);
      color: #fff;
      border: none;
      padding: 12px 0;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      transition: box-shadow 0.2s, background 0.2s;
    }
    .btn-primary:hover {
      box-shadow: 0 3px 10px #f64e8b22;
      background: linear-gradient(90deg, #a980ee, #f64e8b);
    }
    .voice-record {
      display: block;
      margin: 12px 0 0 0;
      text-align: left;
    }
    @media (max-width: 500px) {
      .container { padding: 18px 4vw; }
    }
  </style>
</head>
<body>
  <div id="mainContent" style="display:none;">
    <div class="container">
      <h2>Create a Card</h2>
      <form id="cardForm">
        <div class="form-group">
          <label for="recipientName">Recipient Name</label>
          <input type="text" id="recipientName" required>
        </div>
        <div class="form-group">
          <label for="cardTitle">Card Title</label>
          <input type="text" id="cardTitle" required>
        </div>
        <div class="form-group">
          <label for="message">Message</label>
          <textarea id="message" required></textarea>
        </div>
        <div class="form-group">
          <label>Add Stickers</label>
          <div class="stickers">
            <button type="button" class="sticker-btn" data-sticker="‚ù§Ô∏è">‚ù§Ô∏è</button>
            <button type="button" class="sticker-btn" data-sticker="üéâ">üéâ</button>
            <button type="button" class="sticker-btn" data-sticker="üåü">üåü</button>
            <button type="button" class="sticker-btn" data-sticker="üòç">üòç</button>
            <button type="button" class="sticker-btn" data-sticker="ü•∞">ü•∞</button>
          </div>
        </div>
        <div class="form-group">
          <label>Card Background</label>
          <div class="backgrounds">
            <button type="button" class="background-btn" data-bg="white" style="background:#fff;">White</button>
            <button type="button" class="background-btn" data-bg="pink" style="background:#ffe4f5;">Pink</button>
            <button type="button" class="background-btn" data-bg="blue" style="background:#c1d8ff;">Blue</button>
          </div>
        </div>
        <div class="form-group">
          <label for="mainPhoto">Main Photo</label>
          <div class="photo-upload">
            <input type="file" id="mainPhoto" accept="image/*">
          </div>
        </div>
        <div class="form-group">
          <label class="voice-record">Voice Message (optional)</label>
          <button type="button" id="recordVoice" class="btn-primary" style="font-size:14px;padding:8px;">Record Your Voice</button>
          <span id="voiceStatus"></span>
        </div>
        <button type="submit" class="btn-primary">Save Draft & Show Preview</button>
      </form>
    </div>
  </div>
  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // 1. Firebase config (update bucket as you confirmed)
    const firebaseConfig = {
      apiKey: "AIzaSyAZgVaMTSBMMSn0Nbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.firebasestorage.app",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7",
      measurementId: "G-RGVFSSPMG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 2. Auth check (fixes redirect bug)
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        document.getElementById('mainContent').style.display = 'block';
      }
    });

    // 3. Stickers/backgrounds UI
    let selectedSticker = "";
    let selectedBG = "white";
    document.querySelectorAll('.sticker-btn').forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll('.sticker-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedSticker = btn.dataset.sticker;
      }
    });
    document.querySelectorAll('.background-btn').forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll('.background-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedBG = btn.dataset.bg;
      }
    });

    // 4. Voice record mockup (real implementation is complex)
    document.getElementById("recordVoice").onclick = function() {
      document.getElementById("voiceStatus").textContent = "üé§ Voice recording coming soon!";
    };

    // 5. Save Draft
    document.getElementById("cardForm").onsubmit = async function(e) {
      e.preventDefault();
      const user = firebase.auth().currentUser;
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const recipientName = document.getElementById('recipientName').value.trim();
      const cardTitle = document.getElementById('cardTitle').value.trim();
      const message = document.getElementById('message').value.trim();
      const mainPhotoFile = document.getElementById('mainPhoto').files[0];
      // Save photo to Firebase Storage (if present)
      let photoURL = "";
      if (mainPhotoFile) {
        const photoRef = storage.ref(`cards/${user.uid}/${Date.now()}_${mainPhotoFile.name}`);
        await photoRef.put(mainPhotoFile);
        photoURL = await photoRef.getDownloadURL();
      }
      // Save card to Firestore
      const cardDoc = {
        uid: user.uid,
        recipientName,
        cardTitle,
        message,
        sticker: selectedSticker,
        background: selectedBG,
        photoURL,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const docRef = await db.collection("cards").add(cardDoc);
      // Save draftId to session/localstorage for preview page
      localStorage.setItem("lastCardId", docRef.id);
      // Go to preview
      window.location.href = "preview.html";
    };
  </script>
</body>
</html>
