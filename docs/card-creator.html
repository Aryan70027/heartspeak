<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Create Card - HeartSpeak</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    /* ...existing styles (no changes)... */
  </style>
</head>
<body>
  <header>
    <img src="img/logo.png" class="logo" style="height:80px;margin:0 auto;display:block;" alt="HeartSpeak"/>
  </header>
  <main style="max-width:400px;margin:0 auto;text-align:center;">
    <h1>Create a Card</h1>
    <form id="cardForm">
      <label>Main Photo<br>
        <input type="file" id="mainPhoto" accept="image/*"/>
      </label>
      <br><br>
      <label>Add Stickers<br>
        <span id="stickers">
          <button type="button" data-sticker="ğŸ‚">ğŸ‚</button>
          <button type="button" data-sticker="â¤ï¸">â¤ï¸</button>
          <button type="button" data-sticker="ğŸ˜">ğŸ˜</button>
          <button type="button" data-sticker="ğŸ‰">ğŸ‰</button>
        </span>
      </label>
      <br><br>
      <label>Card Background<br>
        <input type="radio" name="bg" value="#fff" checked/>White
        <input type="radio" name="bg" value="#ffe6f0"/>Pink
        <input type="radio" name="bg" value="#e6f7ff"/>Blue
      </label>
      <br><br>
      <label>Recipient Name<br>
        <input type="text" id="recipient" maxlength="18"/>
      </label>
      <br><br>
      <label>Card Title<br>
        <input type="text" id="title"/>
      </label>
      <br><br>
      <label>Message<br>
        <textarea id="message"></textarea>
      </label>
      <br><br>
      <div>
        <button type="button" id="recordBtn">
          <span id="micIcon">ğŸ¤</span> <span id="recordText">Record Your Voice</span>
        </button>
        <button type="button" id="deleteVoiceBtn" style="display:none;">Delete/Reset Recording</button>
        <audio id="audioPlayer" style="display:none;" controls></audio>
      </div>
      <br>
      <button type="button" id="saveDraftBtn">Save Draft & Show Preview</button>
    </form>
    <div id="status" style="margin-top:1em;color:green;"></div>
  </main>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // ---- FIREBASE INIT ----
    const firebaseConfig = {
      apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.firebasestorage.app",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7",
      measurementId: "G-RGVFVSSPMG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ---- STICKERS ----
    let stickers = [];
    document.querySelectorAll('#stickers button').forEach(btn => {
      btn.onclick = () => {
        if (!stickers.includes(btn.dataset.sticker)) {
          stickers.push(btn.dataset.sticker);
          btn.style.opacity = 0.5;
        } else {
          stickers = stickers.filter(s => s !== btn.dataset.sticker);
          btn.style.opacity = 1;
        }
      }
    });

    // ---- VOICE RECORD ----
    let recorder, audioBlob = null;
    const recordBtn = document.getElementById('recordBtn');
    const audioPlayer = document.getElementById('audioPlayer');
    const recordText = document.getElementById('recordText');
    const micIcon = document.getElementById('micIcon');
    const deleteVoiceBtn = document.getElementById('deleteVoiceBtn');
    let recording = false;
    recordBtn.onclick = async function() {
      if (!recording) {
        if (!navigator.mediaDevices) return alert("Voice not supported.");
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        recorder = new MediaRecorder(stream);
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = e => {
          audioBlob = new Blob(chunks, {type: "audio/webm"});
          audioPlayer.src = URL.createObjectURL(audioBlob);
          audioPlayer.style.display = "block";
          deleteVoiceBtn.style.display = "inline";
        };
        recorder.start();
        recording = true;
        recordText.textContent = "Recording... Click to Stop";
        micIcon.textContent = "âºï¸";
      } else {
        recorder.stop();
        recording = false;
        recordText.textContent = "Record Your Voice";
        micIcon.textContent = "ğŸ¤";
      }
    }
    deleteVoiceBtn.onclick = () => {
      audioBlob = null;
      audioPlayer.src = "";
      audioPlayer.style.display = "none";
      deleteVoiceBtn.style.display = "none";
    };

    // ---- UPLOAD TO STORAGE ----
    async function uploadFile(file, folder) {
      if (!file) return null;
      const ext = file.name ? file.name.split('.').pop() : 'webm';
      const ref = storage.ref(`${folder}/${Date.now()}_${Math.floor(Math.random()*99999)}.${ext}`);
      await ref.put(file);
      return await ref.getDownloadURL();
    }

    // ---- SAVE DRAFT ----
    document.getElementById('saveDraftBtn').onclick = async function() {
      document.getElementById('status').textContent = "Saving draft...";
      // Get form values
      const photoFile = document.getElementById('mainPhoto').files[0];
      const bg = document.querySelector('input[name="bg"]:checked').value;
      const recipient = document.getElementById('recipient').value;
      const title = document.getElementById('title').value;
      const message = document.getElementById('message').value;

      // Upload main photo (if any)
      let photoURL = "";
      if (photoFile) photoURL = await uploadFile(photoFile, "card_photos");
      // Upload voice (if any)
      let voiceURL = "";
      if (audioBlob) {
        const file = new File([audioBlob], "voice.webm", {type: "audio/webm"});
        voiceURL = await uploadFile(file, "card_voice");
      }

      // Require user to be logged in
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("You must be logged in!");
        document.getElementById('status').textContent = "";
        return;
      }

      // Save card data to Firestore
      await db.collection('cards').add({
        uid: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        recipient, title, message, stickers, bg, photoURL, voiceURL
      });

      document.getElementById('status').textContent = "Draft saved! Redirecting...";
      setTimeout(() => {
        window.location.href = "preview.html";
      }, 1200);
    }
  </script>
</body>
</html>
