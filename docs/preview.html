<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preview Dedication â€“ HeartSpeak</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body {
      background: linear-gradient(120deg,#ffe6f0 40%, #fad7f9 100%);
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      margin: 0; padding: 0;
      position: relative;
      overflow-x: hidden;
    }
    .bg-hearts {
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: 0;
      opacity: 0.16;
      background-image: url('img/heart-bg.png');
      background-repeat: repeat;
      background-size: 120px;
    }
    .logo {
      width: 140px;
      margin: 2.5rem auto 1rem auto;
      display: block;
    }
    h1 {
      text-align: center;
      color: #b250c3;
      font-size: 2.2rem;
      margin-bottom: 2.3rem;
      z-index: 2;
    }
    .cards-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 2rem;
      width: 100%;
      max-width: 950px;
      margin: 0 auto 2.2rem auto;
      justify-items: center;
      z-index: 2;
    }
    .preview-card {
      background: #fff;
      border-radius: 1.3rem;
      box-shadow: 0 4px 24px #d87fe633, 0 2px 6px #fff9;
      padding: 1.5rem 1.1rem 1.2rem 1.1rem;
      text-align: center;
      min-width: 230px; max-width: 330px;
      position: relative;
      transition: box-shadow 0.2s;
    }
    .preview-card:hover {
      box-shadow: 0 6px 32px #b250c355, 0 4px 20px #fff9;
    }
    .preview-title {
      font-size: 1.21rem;
      color: #b250c3;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }
    .preview-recipient {
      font-size: 1rem;
      color: #cc0066;
      margin-bottom: 0.9rem;
    }
    .preview-main-img {
      width: 80px;
      height: 80px;
      border-radius: 1.1rem;
      object-fit: cover;
      box-shadow: 0 2px 10px #fbb5dd77;
      margin-bottom: 1rem;
    }
    .preview-message {
      color: #7c2e94;
      font-size: 1.05rem;
      margin-bottom: 1rem;
    }
    .preview-stickers {
      margin-bottom: 0.8rem;
      font-size: 1.45rem;
    }
    .preview-voice {
      margin-bottom: 1rem;
    }
    .card-actions {
      display: flex;
      gap: 0.6rem;
      justify-content: center;
      margin-top: 0.7rem;
    }
    .card-actions button {
      padding: 0.45rem 0.95rem;
      font-size: 0.99rem;
      border-radius: 0.9rem;
      border: none;
      color: #fff;
      background: linear-gradient(90deg, #b250c3 60%, #fbb5dd 120%);
      cursor: pointer;
      font-weight: 500;
      transition: background 0.15s;
    }
    .card-actions button:active {
      background: linear-gradient(90deg,#cc0066 60%, #b250c3 120%);
    }
    .no-cards-msg {
      text-align: center;
      color: #b250c3;
      font-size: 1.14rem;
      margin-top: 2.2rem;
      font-weight: 500;
    }
    .back-btn {
      display: block;
      margin: 2.3rem auto 0 auto;
      padding: 1rem 2.3rem;
      background: linear-gradient(90deg,#b250c3,#fbb5dd 80%);
      color: #fff;
      border: none;
      border-radius: 2.5rem;
      font-size: 1.22rem;
      font-weight: 700;
      box-shadow: 0 2px 16px #b250c344;
      letter-spacing: 1px;
      cursor: pointer;
      transition: background 0.18s, transform 0.13s;
    }
    .back-btn:active { transform: scale(.96);}
    @media (max-width:700px) {
      .cards-list {gap: 1.1rem;}
      .preview-card {min-width: 170px;}
    }
  </style>
</head>
<body>
  <div class="bg-hearts"></div>
  <img src="img/logo.png" alt="HeartSpeak Logo" class="logo" />
  <h1>Your Latest Cards</h1>
  <div class="cards-list" id="cardsList">
    Loading your latest cards...
  </div>
  <button class="back-btn" onclick="window.location.href='dashboard.html'">&larr; Back to Dashboard</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Firebase setup
    const firebaseConfig = {
      apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.appspot.com",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7",
      measurementId: "G-RGVFVSSPMG"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Fetch and show latest 3 cards
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const cardsList = document.getElementById("cardsList");
      cardsList.innerHTML = "Loading your latest cards...";
      try {
        const snap = await db.collection("cards")
          .where("uid", "==", user.uid)
          .orderBy("createdAt", "desc")
          .limit(3)
          .get();

        if (snap.empty) {
          cardsList.innerHTML = `<div class="no-cards-msg">No cards yet! Go create your first card ðŸŽ‰</div>`;
          return;
        }
        cardsList.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const bg = data.cardBg || "#ffe6f0";
          const mainImg = data.mainImg || "img/logo.png";
          const stickers = (data.stickers || []).map(st=>`<span>${st}</span>`).join('');
          const voice = data.voiceMsg ? 
            `<div class="preview-voice"><span>ðŸ”Š Voice Message:</span><audio controls src="${data.voiceMsg}"></audio></div>` : '';
          const card = document.createElement("div");
          card.className = "preview-card";
          card.innerHTML = `
            <div class="preview-title">${data.title || "HeartSpeak Card"}</div>
            <div class="preview-recipient">To: ${data.recipient || "Friend"}</div>
            <img src="${mainImg}" class="preview-main-img" alt="Card Main">
            <div class="preview-message">${data.message || "Best wishes!"}</div>
            <div class="preview-stickers">${stickers}</div>
            ${voice}
            <div class="card-actions">
              <button onclick="editCard('${doc.id}')">Edit</button>
              <button onclick="deleteCard('${doc.id}', this)">Delete</button>
              <button onclick="generateLink('${doc.id}')">Generate Link</button>
            </div>
          `;
          cardsList.appendChild(card);
        });
      } catch (err) {
        cardsList.innerHTML = `<div class="no-cards-msg">Error loading cards. Try again later.</div>`;
        console.error("Error fetching cards: ", err);
      }
    });

    // Card actions (edit, delete, generate link)
    function editCard(cardId) {
      // Redirect to card-creator.html with cardId in localStorage
      localStorage.setItem("editCardId", cardId);
      window.location.href = "card-creator.html";
    }
    async function deleteCard(cardId, btn) {
      if (!confirm("Delete this card?")) return;
      btn.disabled = true;
      try {
        await firebase.firestore().collection("cards").doc(cardId).delete();
        btn.parentNode.parentNode.remove();
      } catch (e) {
        alert("Delete failed. Try again.");
        btn.disabled = false;
      }
    }
    function generateLink(cardId) {
      localStorage.setItem("lastCardId", cardId);
      window.location.href = "share-settings.html";
    }
  </script>
</body>
</html>
