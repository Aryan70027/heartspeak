<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preview Cards ‚Äì HeartSpeak</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body {
      background: linear-gradient(120deg,#ffe6f0 40%, #f3e7fd 100%);
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 0; min-height: 100vh;
      overflow-x: hidden;
    }
    header {
      text-align: center;
      margin-top: 2rem;
      margin-bottom: 1.2rem;
    }
    .logo {
      width: 120px;
      height: auto;
      border-radius: 1.5rem;
      box-shadow: 0 2px 16px #fbb5dd55;
    }
    .preview-container {
      max-width: 900px;
      margin: auto;
      padding: 0 1rem 3rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      text-align: center;
      font-size: 2.1rem;
      color: #b250c3;
      margin-bottom: 2rem;
    }
    .cards-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 2.2rem;
      margin-bottom: 1.8rem;
    }
    .preview-card {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 3px 18px #b4aad688;
      padding: 2rem 1.3rem 1.2rem 1.3rem;
      min-width: 260px; max-width: 330px; width: 100%;
      display: flex; flex-direction: column; align-items: center; gap: 1rem;
      position: relative;
      overflow: hidden;
      animation: popIn 1s;
      margin: auto;
    }
    @keyframes popIn {
      0% { transform: scale(.93); opacity: 0;}
      80% { transform: scale(1.03);}
      100% { transform: scale(1); opacity:1;}
    }
    .preview-bg {
      position: absolute; inset: 0;
      border-radius: 1.2rem;
      z-index: 0;
      opacity: 0.32;
    }
    .preview-main-img {
      width: 86px; height: 86px; object-fit: cover;
      border-radius: 1.1rem;
      box-shadow: 0 2px 14px #c88ad433;
      z-index: 2;
    }
    .preview-title {
      color: #b250c3; font-size: 1.1rem; font-weight: 600; z-index:2;
    }
    .preview-recipient {
      font-size: 1.13rem; font-weight: 600; color: #cc0066; margin-bottom: 0.2rem; z-index:2;
    }
    .preview-message {
      color: #6a227c; font-size: 1rem; text-align: center; z-index:2;
      min-height: 40px;
    }
    .preview-stickers {
      display: flex; gap: 3px; flex-wrap: wrap; margin-top: 0.2rem; z-index:2;
    }
    .preview-sticker {
      font-size: 1.25rem;
    }
    .preview-voice {
      margin-top: 0.4rem; z-index:2;
      background: #ffe5f2; border-radius: 0.6rem;
      padding: 0.4rem 0.7rem;
      display: flex; align-items: center; gap: 0.7rem;
    }
    .preview-voice span {
      color:#b250c3;font-weight:600;
    }
    .card-actions {
      margin-top: 1.1rem;
      display: flex;
      gap: 1.3rem;
      justify-content: center;
    }
    .card-actions button {
      padding: 0.47rem 1.25rem;
      font-size: 0.97rem;
      border: none;
      border-radius: 1.4rem;
      background: linear-gradient(90deg,#b250c3,#fbb5dd 80%);
      color: #fff; font-weight: 600;
      box-shadow: 0 2px 9px #b250c355;
      cursor: pointer;
      transition: background 0.17s, transform 0.12s;
    }
    .card-actions button:active { transform: scale(.97);}
    .no-cards-msg {
      text-align: center; font-size: 1.13rem;
      color: #9c36a6; margin: 3rem 0 2rem 0;
    }
    .back-btn {
      display: inline-block;
      margin-top: 2.2rem;
      padding: 0.72rem 2.3rem;
      border: none;
      border-radius: 2rem;
      background: linear-gradient(90deg,#b250c3,#fbb5dd 80%);
      color: #fff;
      font-size: 1.06rem;
      font-weight: 600;
      box-shadow: 0 2px 12px #b250c322;
      cursor: pointer;
      transition: background 0.17s, transform 0.12s;
    }
    .back-btn:active { transform: scale(.96);}
    /* Animated hearts/confetti (example with hearts) */
    .bg-anim {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .heart {
      position: absolute;
      color: #ff92be;
      font-size: 2rem;
      opacity: 0.4;
      animation: floatHearts 8s linear infinite;
    }
    @keyframes floatHearts {
      0% { transform: translateY(110vh) scale(0.8) rotate(0deg);}
      100% { transform: translateY(-10vh) scale(1.18) rotate(38deg);}
    }
    @media (max-width: 900px) {
      .preview-container { padding: 0 0.2rem;}
      .cards-list { gap: 1.1rem; }
      .preview-card { min-width: 95vw; max-width: 98vw;}
    }
  </style>
</head>
<body>
  <!-- Animated floating hearts background -->
  <div class="bg-anim" id="bgAnim"></div>
  <header>
    <img src="img/logo.png" alt="HeartSpeak Logo" class="logo" />
  </header>
  <div class="preview-container">
    <h1>Your Latest Cards</h1>
    <div class="cards-list" id="cardsList"></div>
    <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Back to Dashboard</button>
  </div>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // Animate floating hearts in background
    function createHearts() {
      const container = document.getElementById('bgAnim');
      for(let i=0;i<16;i++) {
        const heart = document.createElement('div');
        heart.className = 'heart';
        heart.style.left = Math.random()*98+'vw';
        heart.style.animationDelay = (Math.random()*8)+'s';
        heart.innerHTML = 'üíñ';
        heart.style.fontSize = (1.5+Math.random()*1.3) + 'rem';
        container.appendChild(heart);
      }
    }
    createHearts();

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.appspot.com",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7",
      measurementId: "G-RGVFVSSPMG"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Load last 3 cards for the logged-in user
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const cardsList = document.getElementById("cardsList");
      cardsList.innerHTML = "Loading your latest cards...";
      const snap = await db.collection("cards")
        .where("uid","==",user.uid)
        .orderBy("createdAt","desc")
        .limit(3)
        .get();
      if (snap.empty) {
        cardsList.innerHTML = `<div class="no-cards-msg">No cards yet! Go create your first card üéâ</div>`;
        return;
      }
      cardsList.innerHTML = "";
      snap.forEach(doc => {
        const data = doc.data();
        // Build card preview HTML
        const bg = data.cardBg || "#ffe6f0";
        const mainImg = data.mainImg || "img/demo-avatar.jpg";
        const stickers = (data.stickers || []).map(st=>`<span class="preview-sticker">${st}</span>`).join('');
        const voice = data.voiceMsg ? 
          `<div class="preview-voice"><span>üîä Voice Message:</span><audio controls src="${data.voiceMsg}"></audio></div>` : '';
        const card = document.createElement("div");
        card.className = "preview-card";
        card.innerHTML = `
          <div class="preview-bg" style="background:${bg};"></div>
          <div class="preview-title">${data.title || "Happy Birthday!"}</div>
          <div class="preview-recipient">To: ${data.recipient || "Aryan"}</div>
          <img src="${mainImg}" class="preview-main-img" alt="Card Main">
          <div class="preview-message">${data.message || "Best wishes!"}</div>
          <div class="preview-stickers">${stickers}</div>
          ${voice}
          <div class="card-actions">
            <button onclick="editCard('${doc.id}')">Edit</button>
            <button onclick="deleteCard('${doc.id}', this)">Delete</button>
            <button onclick="generateLink('${doc.id}')">Generate Link</button>
          </div>
        `;
        cardsList.appendChild(card);
      });
    });

    // Edit: store card ID, redirect to card-creator.html with editing mode
    function editCard(id) {
      localStorage.setItem("editCardId", id);
      window.location.href = "card-creator.html";
    }
    // Delete: remove from Firestore
    async function deleteCard(id, btn) {
      if (!confirm("Are you sure you want to delete this card?")) return;
      btn.disabled = true;
      await db.collection("cards").doc(id).delete();
      btn.closest('.preview-card').remove();
    }
    // Generate Link: save card ID for share-settings.html
    function generateLink(id) {
      localStorage.setItem("lastCardId", id);
      window.location.href = "share-settings.html";
    }
  </script>
</body>
</html>
