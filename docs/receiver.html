<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Open Your Surprise | HeartSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/receiver.css">
</head>
<body>
  <!-- Animated hearts background -->
  <canvas class="hearts-bg"></canvas>

  <div class="receiver-container">
    <!-- Main photo or logo -->
    <img id="mainPhoto" src="img/logo.png" alt="HeartSpeak Logo" class="main-photo-premium" />

    <!-- Simple gift box emoji -->
    <div class="simple-gift-box" id="giftboxBtn" style="cursor:pointer; width:120px; height:120px; margin:auto;">
      <span style="font-size:70px;">üéÅ</span>
    </div>

    <button id="openGiftBtn" class="next-btn" style="margin-top:12px; background: linear-gradient(90deg,#f571e6,#62bcfb);color:#fff;font-size:1.3em;">Open Your Surprise</button>

    <!-- Card Content (hidden by default) -->
    <div id="cardContent" style="display:none;">
      <img id="cardphoto" class="circle-photo" src="" alt="photo" />
      <div id="recipientName" class="recipient-name"></div>
      <div id="cardTitle" class="card-title"></div>

      <!-- Audio voice (auto play, hidden controls) -->
      <div id="voiceBlock" class="voice-block" style="display:none;">
        <audio id="voiceAudio" src="" autoplay></audio>
        <button id="playAgainBtn" style="display:none;">üîÅ Play Again</button>
      </div>
      <!-- Next Step Button -->
      <button id="nextBtn" class="next-btn" style="display:none;">Next</button>
    </div>

    <!-- Message Step (hidden by default) -->
    <div id="msgStep" class="msg-box" style="display:none;">
      <span id="msgText"></span>
      <img src="img/envelope.png" class="envelope" alt="Envelope">
      <!-- Reply feature -->
      <div id="replySection" style="margin-top:18px;">
        <textarea id="replyInput" maxlength="200" placeholder="Send your reply (text, or upload image/video below)" style="width:90%;border-radius:10px;"></textarea>
        <br>
        <input type="file" id="replyFile" accept="image/,video/" style="margin-top:7px;">
        <button id="sendReplyBtn" style="margin-top:10px;">Send Reply</button>
        <span id="replyStatus"></span>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      Card made with <b>HeartSpeak</b> üíå ‚Äî <a href="https://aryan70027.github.io/heartspeak/" style="color:#5a6dff;">Create your own card</a>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="pw-modal-bg" id="pwModalBG" style="display:none;">
    <div class="pw-modal big" id="pwModal">
      <div style="font-size:1.25em;">This card is protected <span>üîí</span></div>
      <input id="pwInput" maxlength="32" placeholder="Enter password" autocomplete="off" type="password" style="margin:16px 0; padding:8px; border-radius:6px;">
      <button class="btn" id="pwSubmitBtn">Unlock</button>
      <div id="pwError" style="color:red;margin-top:7px;display:none;">Wrong password!</div>
    </div>
  </div>
  <!-- Firebase SDKs (do not change) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- Firebase Config (update with your config if changed) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDxPAZwmH5pjMUM5NODwbA0vDxvwz5cGU",
      authDomain: "heartspeak-b1703.firebaseapp.com",
      projectId: "heartspeak-b1703",
      storageBucket: "heartspeak-b1703.firebasestorage.app",  // IMPORTANT!
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
  <script>
const cardId = new URLSearchParams(window.location.search).get('cardId');
let cardData = null;
let replyFileData = null;

// DOM elements
const giftboxBtn = document.getElementById('giftboxBtn');
const openGiftBtn = document.getElementById('openGiftBtn');
const cardContent = document.getElementById('cardContent');
const cardphoto = document.getElementById('cardphoto');
const mainPhoto = document.getElementById('mainPhoto');
const recipientName = document.getElementById('recipientName');
const cardTitle = document.getElementById('cardTitle');
const voiceBlock = document.getElementById('voiceBlock');
const voiceAudio = document.getElementById('voiceAudio');
const playAgainBtn = document.getElementById('playAgainBtn');
const nextBtn = document.getElementById('nextBtn');
const msgStep = document.getElementById('msgStep');
const msgText = document.getElementById('msgText');
const replySection = document.getElementById('replySection');
const replyInput = document.getElementById('replyInput');
const replyFile = document.getElementById('replyFile');
const sendReplyBtn = document.getElementById('sendReplyBtn');
const replyStatus = document.getElementById('replyStatus');

// Password modal
const pwModalBG = document.getElementById('pwModalBG');
const pwInput = document.getElementById('pwInput');
const pwSubmitBtn = document.getElementById('pwSubmitBtn');
const pwError = document.getElementById('pwError');

// Show password modal if card is protected
function checkPassword(card) {
  if (card.password) {
    pwModalBG.style.display = "flex";
    pwSubmitBtn.onclick = async function() {
      if (pwInput.value === card.password) {
        pwModalBG.style.display = "none";
        showGiftStep();
      } else {
        pwError.style.display = "block";
      }
    }
  } else {
    showGiftStep();
  }
}

// Show initial box step
function showGiftStep() {
  document.getElementById('giftboxBtn').style.display = "";
  openGiftBtn.style.display = "";
  cardContent.style.display = "none";
  msgStep.style.display = "none";
}

// Open box event (step 1)
openGiftBtn.onclick = giftboxBtn.onclick = function() {
  document.getElementById('giftboxBtn').style.display = "none";
  openGiftBtn.style.display = "none";
  showCardContent();
}

function showCardContent() {
  cardContent.style.display = "";
  if (cardData) {
    if (cardData.photoURL) {
      cardphoto.src = cardData.photoURL;
      mainPhoto.src = cardData.photoURL;
    }
    recipientName.textContent = cardData.recipientName || '';
    cardTitle.textContent = cardData.cardTitle || '';
    if (cardData.voiceURL) {
      voiceBlock.style.display = "";
      voiceAudio.src = cardData.voiceURL;
      voiceAudio.play();
      playAgainBtn.style.display = "";
      playAgainBtn.onclick = () => voiceAudio.play();
    }
    nextBtn.style.display = "";
    nextBtn.onclick = function() {
      cardContent.style.display = "none";
      showMessageStep();
    }
  }
}

// Typewriter effect for message
function typeWriter(text, element, i = 0) {
  if (i < text.length) {
    element.innerHTML += text.charAt(i);
    setTimeout(() => typeWriter(text, element, i + 1), 30);
  }
}

// Show message step (step 2)
function showMessageStep() {
  msgStep.style.display = "";
  msgText.innerHTML = "";
  typeWriter(cardData.message || '', msgText);
}

// ========== REPLY FEATURE ==========

// Handle file select (image/video <1MB)
replyFile.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file && file.size > 1024 * 1024) {
    replyStatus.textContent = "File too large (max 1MB)";
    replyFile.value = "";
    replyFileData = null;
  } else {
    replyFileData = file;
    replyStatus.textContent = "";
  }
});

sendReplyBtn.onclick = async function() {
  replyStatus.textContent = "Sending...";
  let replyURL = null;
  if (replyFileData) {
    const ext = replyFileData.name.split('.').pop();
    const storageRef = storage.ref(cards/${cardId}/replies/${Date.now()}.${ext});
    await storageRef.put(replyFileData);
    replyURL = await storageRef.getDownloadURL();
  }
  // Save reply to Firestore
  await db.collection("cards").doc(cardId).collection("replies").add({
    text: replyInput.value,
    fileURL: replyURL || null,
    fileType: replyFileData ? replyFileData.type : null,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
  });
  replyStatus.textContent = "Reply sent! üéâ";
  replyInput.value = "";
  replyFile.value = "";
  replyFileData = null;
}

// ========== FETCH CARD DATA ==========

async function loadCard() {
  if (!cardId) {
    alert("Card ID missing.");
    return;
  }
  const cardDoc = await db.collection("cards").doc(cardId).get();
  if (!cardDoc.exists) {
    alert("Card not found.");
    return;
  }
  cardData = cardDoc.data();
  checkPassword(cardData);
}

loadCard();
</script>
</body>
</html>
