<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Send Proposal | HeartSpeak</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: radial-gradient(ellipse at 70% 10%, #38295f 0%, #e44c7e 80%);
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0; padding: 0; min-height: 100vh;
        }
        .container {
            max-width: 410px;
            margin: 38px auto;
            padding: 32px 20px;
            background: #fff;
            border-radius: 26px;
            box-shadow: 0 12px 32px #e68fda22, 0 2px 10px #a07bfa16;
            text-align: center;
        }
        .container h1 {
            font-size: 2.1em;
            color: #d2378b;
            margin-bottom: 22px;
        }
        .icon-row {
            display: flex;
            justify-content: center;
            gap: 1.1rem;
            margin-bottom: 1.3rem;
        }
        .icon-choose {
            background: #f5e5f4;
            border: 2.5px solid #d2378b44;
            border-radius: 1em;
            padding: 0.7em 1.2em;
            font-size: 2em;
            color: #d2378b;
            cursor: pointer;
            box-shadow: 0 2px 8px #e44c7e20;
            transition: border 0.22s, background 0.22s;
        }
        .icon-choose.selected {
            border: 3.5px solid #ffb16d;
            background: #ffe3c870;
            color: #bc4bb6;
        }
        .input-group { margin-bottom: 18px; text-align: left; }
        label { display: block; font-weight: 500; margin-bottom: 7px; color: #555;}
        input[type="text"], textarea {
            width: 100%;
            padding: 9px 12px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 6px;
            box-sizing: border-box;
        }
        textarea { min-height: 65px; resize: vertical; }
        #recordVoiceBtn.recording {
            background: #b32e73 !important;
            color: #fff;
        }
        #audioPlayer { margin-top: 10px;}
        #sendBtn {
            background: linear-gradient(90deg, #e979c7, #95c8ff);
            color: white;
            font-size: 1.15em;
            padding: 12px 0;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            transition: background 0.2s;
        }
        #sendBtn:hover {
            background: linear-gradient(90deg, #c678b4, #6fa8dc);
        }
        #voicePreview .delete-btn {
            background: #af2b3f;
            color: #fff;
            border: none;
            padding: 0.28em 1em;
            border-radius: 8px;
            margin-top: 0.6em;
            cursor: pointer;
            font-size: 1em;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div id="mainContent" style="display:none;">
        <div class="container">
            <img src="img/logo.png" style="width:54px; border-radius:15px; margin-bottom:10px;" alt="HeartSpeak Logo">
            <h1>Send Proposal</h1>
            <div class="icon-row">
                <div class="icon-choose selected" data-value="üíç">üíç</div>
                <div class="icon-choose" data-value="üåπ">üåπ</div>
                <div class="icon-choose" data-value="‚ù§Ô∏è">‚ù§Ô∏è</div>
                <div class="icon-choose" data-value="ü¶ã">ü¶ã</div>
            </div>
            <form id="proposalForm">
                <div class="input-group">
                    <label for="receiver">To (Receiver's Name or Username)</label>
                    <input type="text" id="receiver" required>
                </div>
                <div class="input-group">
                    <label for="message">Proposal Message</label>
                    <textarea id="message" required></textarea>
                </div>
                <div class="input-group">
                    <label>Record a Voice Message</label>
                    <button id="recordVoiceBtn" type="button">üé§ Record Voice</button>
                    <div id="voicePreview"></div>
                </div>
                <button type="button" id="sendBtn">Send Proposal</button>
            </form>
        </div>
    </div>
    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script>
        // Your Firebase config (keep as is!)
        const firebaseConfig = {
            apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
            authDomain: "heartspeak-bf703.firebaseapp.com",
            projectId: "heartspeak-bf703",
            storageBucket: "heartspeak-bf703.firebasestorage.app",
            messagingSenderId: "341260618790",
            appId: "1:341260618790:web:f60536bac144fb815aaae7",
            measurementId: "G-RGVFVSSPMG"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        firebase.auth().onAuthStateChanged(function(user) {
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            document.getElementById('mainContent').style.display = "block";

            // Emoji/ring selector logic
            let chosenIcon = "üíç";
            document.querySelectorAll('.icon-choose').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('.icon-choose').forEach(e => e.classList.remove('selected'));
                    btn.classList.add('selected');
                    chosenIcon = btn.getAttribute('data-value');
                };
            });

            // Voice recording logic
            let recorder, audioStream, audioChunks = [];
            let isRecording = false;
            let recordedAudioBlob = null;
            const recordBtn = document.getElementById('recordVoiceBtn');
            const voicePreview = document.getElementById('voicePreview');

            recordBtn.onclick = async function() {
                if (!isRecording) {
                    if (navigator.mediaDevices && window.MediaRecorder) {
                        audioStream = await navigator.mediaDevices.getUserMedia({audio: true});
                        recorder = new MediaRecorder(audioStream);
                        audioChunks = [];
                        recorder.ondataavailable = e => audioChunks.push(e.data);
                        recorder.onstop = e => {
                            recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            showVoicePreview(recordedAudioBlob);
                            recordBtn.textContent = "Record Again";
                            recordBtn.classList.remove("recording");
                            isRecording = false;
                            audioStream.getTracks().forEach(track => track.stop());
                        };
                        recorder.start();
                        recordBtn.textContent = "Stop Recording";
                        recordBtn.classList.add("recording");
                        isRecording = true;
                    } else {
                        alert('Voice recording not supported!');
                    }
                } else {
                    recorder.stop();
                }
            };

            function showVoicePreview(blob) {
                voicePreview.innerHTML = "";
                if (blob) {
                    const url = URL.createObjectURL(blob);
                    voicePreview.innerHTML = `
                        <audio controls src="${url}" style="width:100%;margin-top:0.5em;"></audio>
                        <button class="delete-btn" type="button" id="deleteVoiceBtn">Delete</button>
                    `;
                    document.getElementById('deleteVoiceBtn').onclick = () => {
                        recordedAudioBlob = null;
                        voicePreview.innerHTML = "";
                        recordBtn.textContent = "üé§ Record Voice";
                    };
                }
            }

            // Send Proposal logic
            document.getElementById('sendBtn').onclick = async function(e) {
                e.preventDefault();
                const receiver = document.getElementById('receiver').value.trim();
                const message = document.getElementById('message').value.trim();
                if (!receiver || !message) {
                    alert("Please fill in all fields.");
                    return;
                }
                let voiceURL = "";
                if (recordedAudioBlob) {
                    const audioRef = storage.ref().child(`cards/${user.uid}/proposal_voice_${Date.now()}.webm`);
                    await audioRef.put(recordedAudioBlob);
                    voiceURL = await audioRef.getDownloadURL();
                }
                await db.collection("proposals").add({
                    uid: user.uid,
                    receiver,
                    message,
                    emoji: chosenIcon,
                    voiceURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Proposal sent!");
                document.getElementById('proposalForm').reset();
                voicePreview.innerHTML = "";
                recordedAudioBlob = null;
                recordBtn.textContent = "üé§ Record Voice";
            };
        });
    </script>
</body>
</html>
