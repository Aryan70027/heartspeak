<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Send Proposal - HeartSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Twilight Radiance */
      --bg-twilight: linear-gradient(135deg, #222350 0%, #9a1d65 100%);
      --accent-twilight: #eab0ff;
      /* Rose Marble Luxe */
      --bg-rose: linear-gradient(135deg, #ffe3ea 0%, #f7c2d3 70%, #ffe5f7 100%);
      --accent-rose: #c79081;
      /* Aurora Bliss */
      --bg-aurora: linear-gradient(135deg, #31b1ba 0%, #b186fc 60%, #ec9bff 100%);
      --accent-aurora: #90ffe6;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-twilight);
      transition: background 0.6s cubic-bezier(.75,0,.25,1);
    }
    .proposal-container {
      background: rgba(255,255,255,0.15);
      box-shadow: 0 8px 40px 0 #40235044;
      border-radius: 28px;
      padding: 2.3rem 1.5rem 2.5rem;
      max-width: 410px;
      width: 96vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    h1 {
      color: #fff;
      margin-bottom: 0.7rem;
      font-size: 2.1rem;
      letter-spacing: 0.04em;
      text-align: center;
      font-weight: 600;
      text-shadow: 0 2px 18px #0004;
    }
    .theme-switcher {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .theme-btn {
      border: none;
      background: #fff5;
      color: #fff;
      padding: 0.5rem 1.2rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1rem;
      outline: none;
      font-weight: 500;
      transition: background 0.25s, color 0.2s;
      opacity: 0.6;
    }
    .theme-btn.active {
      background: #fff;
      color: #9a1d65;
      opacity: 1;
      font-weight: 700;
      border: 1.5px solid #fff9;
    }

    /* Emoji/ring picker */
    .emoji-picker {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.2rem;
      margin-bottom: 1.4rem;
    }
    .emoji-option {
      font-size: 2.9rem;
      background: rgba(255,255,255,0.20);
      border: 2.5px solid transparent;
      border-radius: 20px;
      padding: 0.3em 0.45em;
      cursor: pointer;
      transition: border 0.24s, box-shadow 0.24s;
      box-shadow: 0 3px 14px #0001;
      filter: grayscale(0.1) brightness(1.1);
    }
    .emoji-option.selected {
      border: 2.5px solid #fff;
      background: rgba(255,255,255,0.30);
      box-shadow: 0 4px 22px #fff3;
      filter: none;
    }

    .form-group {
      width: 100%;
      margin-bottom: 1.1rem;
    }
    label {
      font-weight: 500;
      color: #fff;
      margin-bottom: 0.3rem;
      display: block;
      font-size: 1.01rem;
    }
    input, textarea {
      width: 100%;
      border-radius: 14px;
      border: none;
      font-size: 1.09rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.17);
      color: #23253a;
      margin-bottom: 0.18rem;
      font-family: inherit;
      outline: none;
      box-shadow: 0 2px 7px #fff3;
      transition: background 0.18s;
    }
    input::placeholder, textarea::placeholder {
      color: #aaa;
    }
    textarea {
      resize: vertical;
      min-height: 65px;
      max-height: 160px;
    }
    .action-row {
      display: flex;
      gap: 1.1rem;
      margin-bottom: 1.2rem;
      width: 100%;
    }
    .action-btn {
      flex: 1 1 0;
      background: rgba(255,255,255,0.22);
      color: #8e3b9b;
      border: none;
      padding: 0.85em 0.3em;
      border-radius: 13px;
      font-size: 1.02rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s;
    }
    .action-btn:hover {
      background: #fff6;
    }
    .switch-row {
      display: flex;
      gap: 0.7rem;
      align-items: center;
      margin-bottom: 1.4rem;
      width: 100%;
    }
    .switch-row label {
      color: #fff;
      font-size: 1.06rem;
      font-weight: 500;
      margin: 0;
      flex: 1;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input { opacity: 0; width: 0; height: 0;}
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background: #fff7;
      border-radius: 24px;
      transition: 0.24s;
    }
    .slider:before {
      position: absolute; content: "";
      height: 18px; width: 18px; left: 3px; bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.24s;
      box-shadow: 0 1px 3px #0002;
    }
    .switch input:checked + .slider {
      background: #b186fc;
    }
    .switch input:checked + .slider:before {
      transform: translateX(20px);
      background: #c79081;
    }
    .btn-row {
      display: flex;
      gap: 1.1rem;
      width: 100%;
      margin-top: 1.7rem;
      justify-content: center;
    }
    .main-btn {
      flex: 1 1 0;
      padding: 0.9em 0.1em;
      border: none;
      border-radius: 16px;
      font-size: 1.14rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(90deg,#b186fc 0,#eab0ff 80%);
      box-shadow: 0 3px 22px #9a1d6555;
      cursor: pointer;
      letter-spacing: 0.03em;
      transition: background 0.23s;
    }
    .main-btn.save {
      background: linear-gradient(90deg,#eab0ff 0,#b186fc 80%);
      color: #9a1d65;
    }
    /* Responsive */
    @media (max-width: 540px) {
      .proposal-container {
        padding: 1.15rem 0.7rem 1.5rem;
        max-width: 98vw;
      }
      .emoji-picker { gap: 0.7rem; }
      .main-btn { font-size: 1.03rem; }
    }
  </style>
</head>
<body>
  <div class="proposal-container" id="theme-bg">
    <h1>Send Proposal</h1>
    <div class="theme-switcher">
      <button class="theme-btn active" data-theme="twilight">Twilight Radiance</button>
      <button class="theme-btn" data-theme="rose">Rose Marble Luxe</button>
      <button class="theme-btn" data-theme="aurora">Aurora Bliss</button>
    </div>
    <div class="emoji-picker" id="emojiPicker">
      <span class="emoji-option selected" data-emoji="üíç">üíç</span>
      <span class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
      <span class="emoji-option" data-emoji="ü¶ã">ü¶ã</span>
      <span class="emoji-option" data-emoji="üåπ">üåπ</span>
    </div>
    <form id="proposalForm">
      <div class="form-group">
        <label for="receiver">To</label>
        <input type="text" id="receiver" placeholder="Receiver's name or username" autocomplete="off" required>
      </div>
      <div class="form-group">
        <label for="message">Your Message</label>
        <textarea id="message" placeholder="Type your proposal message..." required></textarea>
      </div>
      <div class="action-row">
        <button type="button" class="action-btn" id="addPhotoBtn">Add Photo</button>
        <button type="button" class="action-btn" id="recordVoiceBtn">Record Voice</button>
      </div>
      <div class="action-row">
        <button type="button" class="action-btn" id="pickMusicBtn">Pick Music</button>
        <label class="switch-row">
          <span>Private</span>
          <span class="switch"><input type="checkbox" id="privateSwitch"><span class="slider"></span></span>
        </label>
      </div>
      <div class="switch-row">
        <label>Schedule</label>
        <span class="switch"><input type="checkbox" id="scheduleSwitch"><span class="slider"></span></span>
      </div>
      <div class="btn-row">
        <button type="button" class="main-btn save" id="saveDraftBtn">Save Draft</button>
        <button type="submit" class="main-btn">Preview</button>
      </div>
      <input type="file" id="photoInput" accept="image/*" style="display:none;">
    </form>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // 1. --- FIREBASE SETUP (Use your correct .app address for storage) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.firebasestorage.app",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 2. --- THEME SWITCHING ---
    const bgMap = {
      twilight: "var(--bg-twilight)",
      rose: "var(--bg-rose)",
      aurora: "var(--bg-aurora)"
    };
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.body.style.background = bgMap[btn.dataset.theme];
        document.body.setAttribute('data-theme', btn.dataset.theme);
      };
    });

    // 3. --- EMOJI PICKER ---
    let selectedEmoji = "üíç";
    document.querySelectorAll('.emoji-option').forEach(el => {
      el.onclick = () => {
        document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        selectedEmoji = el.dataset.emoji;
      };
    });

    // 4. --- FILE/VOICE HANDLERS ---
    let photoURL = "";
    document.getElementById('addPhotoBtn').onclick = () => document.getElementById('photoInput').click();
    document.getElementById('photoInput').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('addPhotoBtn').innerText = "Uploading...";
      const user = auth.currentUser;
      const fileRef = storage.ref(`proposals/photos/${user.uid}-${Date.now()}-${file.name}`);
      await fileRef.put(file);
      photoURL = await fileRef.getDownloadURL();
      document.getElementById('addPhotoBtn').innerText = "Photo Added ‚úîÔ∏è";
    };

    // (Optional) -- Voice, Music, etc, can be added similarly --

    // 5. --- SAVE PROPOSAL TO FIREBASE ---
    document.getElementById('proposalForm').onsubmit = async function(e){
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return alert("Please log in again!");
      const receiver = document.getElementById('receiver').value.trim();
      const message = document.getElementById('message').value.trim();
      if (!receiver || !message) return alert("Please fill out all required fields!");

      const selectedTheme = document.body.getAttribute('data-theme') || "twilight";
      const isPrivate = document.getElementById('privateSwitch').checked;
      const isScheduled = document.getElementById('scheduleSwitch').checked;

      // Prepare proposal data
      const data = {
        uid: user.uid,
        receiver,
        message,
        emoji: selectedEmoji,
        theme: selectedTheme,
        photo: photoURL || "",
        private: isPrivate,
        scheduled: isScheduled,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Save to Firestore
      try {
        await db.collection("proposals").add(data);
        alert("Proposal Saved! Preview or share it anytime.");
        window.location = "preview.html";
      } catch (err) {
        alert("Error saving proposal: " + err.message);
      }
    };

    // 6. --- SAVE DRAFT BUTTON ---
    document.getElementById('saveDraftBtn').onclick = async function(){
      const user = auth.currentUser;
      if (!user) return alert("Please log in again!");
      const receiver = document.getElementById('receiver').value.trim();
      const message = document.getElementById('message').value.trim();
      if (!receiver || !message) return alert("Please fill out all required fields!");

      const selectedTheme = document.body.getAttribute('data-theme') || "twilight";
      const isPrivate = document.getElementById('privateSwitch').checked;
      const isScheduled = document.getElementById('scheduleSwitch').checked;

      const data = {
        uid: user.uid,
        receiver,
        message,
        emoji: selectedEmoji,
        theme: selectedTheme,
        photo: photoURL || "",
        private: isPrivate,
        scheduled: isScheduled,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        draft: true
      };

      try {
        await db.collection("proposals").add(data);
        alert("Draft Saved!");
      } catch (err) {
        alert("Error saving draft: " + err.message);
      }
    };

    // --- AUTH GUARD (protect page) ---
    auth.onAuthStateChanged(user => {
      if (!user) window.location = "login.html";
    });

    // --- Default set Twilight as selected ---
    document.body.setAttribute('data-theme', 'twilight');
    document.body.style.background = bgMap['twilight'];
  </script>
</body>
</html>
