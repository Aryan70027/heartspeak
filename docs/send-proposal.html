<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Send Proposal - HeartSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Icons (ring) -->
  <link rel="icon" href="img/logo.png">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(ellipse at 60% 20%, #31294f 0%, #652d62 60%, #e34d7b 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      color: #fff;
    }
    .proposal-container {
      margin: 32px 0;
      background: rgba(34, 25, 56, 0.98);
      border-radius: 2.2rem;
      padding: 2.4rem 1.1rem 2rem 1.1rem;
      box-shadow: 0 0 32px #8a327be6, 0 4px 24px #b250c366;
      width: 95vw;
      max-width: 430px;
      min-width: 270px;
      text-align: center;
    }
    h1 {
      font-family: 'Poppins', sans-serif;
      margin-bottom: 2rem;
      letter-spacing: .03em;
      font-size: 2.2rem;
      font-weight: 700;
    }
    /* THEME SELECTION */
    .theme-row {
      display: flex;
      justify-content: center;
      gap: 1.1rem;
      margin-bottom: 1.5rem;
    }
    .theme-btn {
      padding: 0.65rem 1.2rem;
      border: none;
      border-radius: 1.4rem;
      font-weight: 500;
      background: #2e1f3c;
      color: #fff;
      font-size: 1rem;
      opacity: 0.5;
      cursor: pointer;
      transition: background 0.25s, opacity 0.2s;
    }
    .theme-btn.active {
      background: linear-gradient(90deg, #d18fff 0%, #e758b8 70%, #ffb16d 100%);
      opacity: 1;
      color: #fff;
    }

    /* ICON SELECTOR */
    .icon-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.1rem;
      margin-bottom: 2.2rem;
    }
    .icon-choose {
      width: 90px;
      height: 90px;
      background: rgba(60,30,80,0.8);
      border-radius: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.8rem;
      border: 2.5px solid transparent;
      cursor: pointer;
      box-shadow: 0 4px 16px #bc5ba822;
      transition: border-color 0.19s, background 0.19s;
    }
    .icon-choose.selected {
      border-color: #ffe499;
      background: linear-gradient(145deg, #ffcf7f 0%, #ed6389 100%);
    }
    /* FIELDS */
    .input-row {
      margin-bottom: 1.3rem;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }
    .proposal-input, .proposal-msg {
      background: #fff1;
      color: #fff;
      border: none;
      border-radius: 1.1rem;
      padding: 1rem 1.3rem;
      font-size: 1.05rem;
      font-family: inherit;
      box-shadow: 0 1px 6px #b250c322;
      margin-bottom: 0.2rem;
    }
    .proposal-msg {
      min-height: 64px;
      resize: vertical;
    }
    /* ACTION BUTTONS */
    .action-row {
      display: flex;
      justify-content: center;
      gap: 1.1rem;
      margin-bottom: 1.1rem;
      flex-wrap: wrap;
    }
    .action-btn {
      background: linear-gradient(90deg,#b485ff,#ffb16d 90%);
      color: #fff;
      border: none;
      border-radius: 1.4rem;
      font-weight: 600;
      font-size: 1.01rem;
      padding: 0.8rem 1.3rem;
      margin: 0.2rem 0;
      cursor: pointer;
      box-shadow: 0 2px 9px #7d2ea04b;
      transition: background 0.2s, color 0.18s;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .action-btn i {
      font-size: 1.1rem;
    }
    .action-btn:active {
      background: linear-gradient(90deg,#ffb16d,#b485ff 90%);
      color: #fff;
    }
    /* Toggle Switch */
    .switch {
      display: inline-block;
      position: relative;
      width: 44px;
      height: 25px;
      margin: 0 12px;
    }
    .switch input {display:none;}
    .slider {
      position: absolute;
      cursor: pointer;
      background: #eee4;
      border-radius: 25px;
      top: 0; left: 0; right: 0; bottom: 0;
      transition: .3s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 19px; width: 19px;
      left: 3px; bottom: 3px;
      background: #ffb16d;
      border-radius: 50%;
      transition: .3s;
    }
    input:checked + .slider {
      background: #ffb16d77;
    }
    input:checked + .slider:before {
      transform: translateX(19px);
      background: #b485ff;
    }
    /* Save/Preview Buttons */
    .footer-btns {
      display: flex;
      gap: 1.3rem;
      margin-top: 2rem;
      justify-content: center;
    }
    .footer-btn {
      background: linear-gradient(90deg,#6f3fa0,#ffb16d 90%);
      color: #fff;
      border: none;
      border-radius: 1.8rem;
      font-weight: 700;
      font-size: 1.09rem;
      padding: 1.1rem 2.3rem;
      margin: 0.2rem 0;
      cursor: pointer;
      box-shadow: 0 2px 13px #b250c366;
      transition: background 0.18s, color 0.18s;
    }
    .footer-btn:active { color: #ffb16d;}
    /* Responsive */
    @media (max-width:600px) {
      .proposal-container {padding: 1.1rem; margin: 12px 0;}
      h1 { font-size: 1.3rem;}
      .footer-btn {font-size: 1rem; padding: 0.7rem 1.2rem;}
      .icon-choose {width: 68px; height: 68px; font-size: 2.1rem;}
    }
  </style>
</head>
<body>
  <div class="proposal-container">
    <h1>Send Proposal</h1>
    <!-- Theme selector row, but disabled for now since only Twilight is used -->
    <div class="theme-row">
      <button class="theme-btn active">Twilight Radiance</button>
    </div>
    <!-- Emoji/Ring picker -->
    <div class="icon-row" id="ringChoice">
      <div class="icon-choose selected" data-value="üíç">üíç</div>
      <div class="icon-choose" data-value="üåπ">üåπ</div>
      <div class="icon-choose" data-value="‚ù§Ô∏è">‚ù§Ô∏è</div>
    </div>
    <div class="input-row">
      <input class="proposal-input" id="receiverInput" type="text" placeholder="To (Receiver's name or username)">
      <textarea class="proposal-msg" id="messageInput" placeholder="Type your proposal message‚Ä¶"></textarea>
    </div>
    <div class="action-row">
      <button class="action-btn" id="addPhotoBtn"><i>üì∏</i> Add Photo</button>
      <button class="action-btn" id="recordVoiceBtn"><i>üé§</i> Record Voice</button>
    </div>
    <div class="action-row">
      <button class="action-btn" id="pickMusicBtn"><i>üéµ</i> Pick Music</button>
      <label style="display:flex;align-items:center;gap:.2rem;">
        <span>Private</span>
        <span class="switch">
          <input type="checkbox" id="privateToggle" />
          <span class="slider"></span>
        </span>
      </label>
      <label style="display:flex;align-items:center;gap:.2rem;">
        <span>Schedule</span>
        <span class="switch">
          <input type="checkbox" id="scheduleToggle" />
          <span class="slider"></span>
        </span>
      </label>
    </div>
    <div class="footer-btns">
      <button class="footer-btn" id="saveDraftBtn">Save Draft</button>
      <button class="footer-btn" id="previewBtn">Preview</button>
    </div>
    <input type="file" id="photoInput" style="display:none;" accept="image/*">
  </div>
  <!-- Firebase SDKs (paste your version, matching your project) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script>
  // 1. INIT FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbb31gfBcwXzseGU",
    authDomain: "heartspeak-bf703.firebaseapp.com",
    projectId: "heartspeak-bf703",
    storageBucket: "heartspeak-bf703.firebasestorage.app",
    messagingSenderId: "341260618790",
    appId: "1:341260618790:web:f60853b6c144fb815aaae7",
    measurementId: "G-RGVFVSSPMG"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // 2. ICON/EMOJI PICKER
  let chosenIcon = "üíç";
  document.querySelectorAll('.icon-choose').forEach((el) => {
    el.onclick = () => {
      document.querySelectorAll('.icon-choose').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      chosenIcon = el.getAttribute('data-value');
    }
  });

  // 3. ADD PHOTO
  let uploadedPhotoUrl = '';
  document.getElementById('addPhotoBtn').onclick = () => {
    document.getElementById('photoInput').click();
  };
  document.getElementById('photoInput').onchange = async function(e) {
    const file = e.target.files[0];
    if (file) {
      // Upload to Firebase Storage
      const uid = (auth.currentUser ? auth.currentUser.uid : Date.now());
      const ref = storage.ref('proposals/' + uid + '/' + file.name);
      await ref.put(file);
      uploadedPhotoUrl = await ref.getDownloadURL();
      alert("Photo uploaded!");
    }
  };

  // 4. RECORD VOICE
  let recordedBlob = null;
  let mediaRecorder, chunks = [];
  const recordBtn = document.getElementById('recordVoiceBtn');
  let isRecording = false;
  recordBtn.onclick = async () => {
    if (!isRecording) {
      // Start recording
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = function(e) { chunks.push(e.data); };
        mediaRecorder.onstop = function() {
          recordedBlob = new Blob(chunks, { 'type': 'audio/webm; codecs=opus' });
          alert('Voice message recorded!');
        };
        mediaRecorder.start();
        isRecording = true;
        recordBtn.textContent = 'Stop Recording';
      }
    } else {
      // Stop recording
      mediaRecorder.stop();
      isRecording = false;
      recordBtn.textContent = 'Record Voice';
    }
  };

  // 5. PICK MUSIC (DEMO ONLY)
  document.getElementById('pickMusicBtn').onclick = () => {
    alert("Music picker is a premium feature! (Demo only)");
  };

  // 6. SAVE DRAFT BUTTON
  document.getElementById('saveDraftBtn').onclick = async () => {
    const receiver = document.getElementById('receiverInput').value.trim();
    const message = document.getElementById('messageInput').value.trim();
    const isPrivate = document.getElementById('privateToggle').checked;
    const isScheduled = document.getElementById('scheduleToggle').checked;
    if (!receiver || !message) { alert("Please fill all fields."); return; }

    let voiceUrl = '';
    if (recordedBlob) {
      // Upload voice to Firebase Storage
      const uid = (auth.currentUser ? auth.currentUser.uid : Date.now());
      const voiceRef = storage.ref('proposals/' + uid + '/voice.webm');
      await voiceRef.put(recordedBlob);
      voiceUrl = await voiceRef.getDownloadURL();
    }
    // Save to Firestore
    const uid = (auth.currentUser ? auth.currentUser.uid : "guest_" + Date.now());
    await db.collection('proposals').add({
      sender: uid,
      receiver,
      message,
      emoji: chosenIcon,
      photo: uploadedPhotoUrl,
      voice: voiceUrl,
      private: isPrivate,
      scheduled: isScheduled,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Draft saved!");
  };

  // 7. PREVIEW BUTTON
  document.getElementById('previewBtn').onclick = () => {
    alert('Preview coming soon!');
  };

  // 8. Auth (Optional: only if you want to restrict sending to logged-in users)
  // auth.onAuthStateChanged(user => {
  //   if (!user) location.href = 'login.html';
  // });

</script>
</body>
</html>
