
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analysis Dashboard | HeartSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body {
      background: linear-gradient(135deg,#f7e8fc 0%,#d2f0ff 100%);
      min-height: 100vh;
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .dashboard-container {
      max-width: 1080px;
      margin: 38px auto 24px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 10px 34px #eaa3f488, 0 2px 4px rgba(0,0,0,0.04);
      padding: 32px 24px 42px;
      position: relative;
      z-index: 2;
      min-height: 70vh;
    }
    .dash-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .dash-logo {
      width: 60px;
      border-radius: 14px;
      margin-right: 18px;
      box-shadow: 0 2px 14px #cd92ee44;
    }
    .dash-title {
      font-size: 2.1em;
      color: #be169d;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-right: 14px;
    }
    .dash-btn {
      background: linear-gradient(90deg,#d86fc8,#6ab7ff);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 8px #dab9f780;
      margin-left: 8px;
      margin-top: 8px;
      transition: background 0.19s;
    }
    .dash-btn:hover { background: linear-gradient(90deg,#c567b4,#499bf2);}
    .summary-cards {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }
    .sum-card {
      flex: 1 1 200px;
      min-width: 180px;
      background: linear-gradient(115deg,#fce1f7 65%,#d8eaff 100%);
      border-radius: 17px;
      box-shadow: 0 3px 12px #e7c3f150;
      padding: 22px 16px 14px;
      text-align: center;
      font-size: 1.07em;
      color: #8833a8;
      font-weight: 600;
      position: relative;
    }
    .sum-card .icon {
      font-size: 1.8em;
      margin-bottom: 9px;
      display: block;
    }
    .cards-list {
      margin-top: 6px;
      border-radius: 18px;
      box-shadow: 0 2px 11px #c2e0f3b1;
      background: #f7faff;
      padding: 12px 8px;
      min-height: 170px;
    }
    .card-row {
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ece1f4;
      padding: 10px 0 7px;
      gap: 13px;
      font-size: 1.02em;
    }
    .card-row:last-child { border-bottom: none; }
    .card-thumb {
      width: 52px;
      height: 52px;
      object-fit: cover;
      border-radius: 12px;
      border: 2px solid #e8b1ef;
      box-shadow: 0 1px 6px #e8b1ef60;
      background: #fff;
      margin-right: 8px;
    }
    .row-col {
      flex: 1;
      min-width: 70px;
      overflow: hidden;
    }
    .card-title-dash {
      font-weight: 600;
      color: #bb167d;
      font-size: 1.07em;
      margin-bottom: 2px;
    }
    .recipient-dash {
      color: #6372a0;
      font-size: 0.97em;
    }
    .date-dash {
      font-size: 0.91em;
      color: #a988cd;
      margin-top: 1px;
    }
    .card-usage {
      font-size: 0.98em;
      color: #4caf50;
      font-weight: 500;
    }
    .btn-analytics {
      background: #f3e6fc;
      color: #9b4aaf;
      border: none;
      border-radius: 7px;
      font-size: 0.98em;
      padding: 6px 14px;
      margin-left: 7px;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 1px 5px #ddb3f433;
    }
    .btn-analytics:hover { background: #f6a6e0; color: #fff; }
    @media (max-width:900px){
      .summary-cards {flex-direction:column;}
      .dashboard-container {padding: 18px 2vw;}
    }
    @media (max-width:540px){
      .dash-title {font-size:1.2em;}
      .dash-header {flex-direction:column; gap:10px;}
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dash-header">
      <img src="img/logo.png" class="dash-logo" alt="HeartSpeak Logo">
      <span class="dash-title">Analysis Dashboard</span>
      <button class="dash-btn" onclick="window.location.href='dashboard.html'">‚¨Ö Back to Home</button>
    </div>
    <div class="summary-cards" id="summaryCards">
      <!-- Summary cards (total, views, replies, etc) will be injected here -->
    </div>
    <div class="cards-list" id="cardsList">
      <!-- Individual cards will show here -->
    </div>
  </div>
  <!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
  // 1. Firebase Config (as before, DO NOT CHANGE)
  const firebaseConfig = {
    apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
    authDomain: "heartspeak-bf703.firebaseapp.com",
    projectId: "heartspeak-bf703",
    storageBucket: "heartspeak-bf703.firebasestorage.app",
    messagingSenderId: "341260618790",
    appId: "1:341260618790:web:f60536bac144fb815aaae7",
    measurementId: "G-RGVFVSSPMG"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 2. Helper - Format date
  function fmtDate(ts) {
    if (!ts) return "";
    const date = ts.toDate ? ts.toDate() : new Date(ts);
    return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  // 3. Load All Cards
  async function loadDashboard() {
    const cardsList = document.getElementById('cardsList');
    const summaryCards = document.getElementById('summaryCards');
    cardsList.innerHTML = '<div style="padding: 24px 0; text-align:center;">Loading cards‚Ä¶</div>';
    summaryCards.innerHTML = '';

    let totalCards = 0, totalViews = 0, totalReplies = 0, usedOnce = 0;
    let allCards = [];

    try {
      const snap = await db.collection('cards').orderBy('createdAt','desc').get();
      if (snap.empty) {
        cardsList.innerHTML = '<div style="padding: 32px 0; color:#d14792; text-align:center; font-size:1.12em;">No cards found!<br>Go create your first card üéâ</div>';
        return;
      }
      cardsList.innerHTML = '';
      snap.forEach(doc => {
        const c = doc.data();
        c.id = doc.id;
        allCards.push(c);
        totalCards++;
        if (c.views) totalViews += Number(c.views);
        if (c.replies && c.replies.length) totalReplies += c.replies.length;
        if (c.expiryType === 'one-time' && c.viewed) usedOnce++;
        // Render row:
        const el = document.createElement('div');
        el.className = 'card-row';
        el.innerHTML = `
          <img class="card-thumb" src="${c.photoURL||'img/logo.png'}" alt="">
          <div class="row-col">
            <div class="card-title-dash">${c.cardTitle || '(No title)'}</div>
            <div class="recipient-dash">To: ${c.recipientName || ''}</div>
            <div class="date-dash">${fmtDate(c.createdAt)}</div>
          </div>
          <div class="row-col card-usage">
            ${c.views ? c.views + ' view' + (c.views>1?'s':'') : 'No views'}
          </div>
          <div class="row-col">
            <button class="btn-analytics" onclick="showAnalytics('${c.id}')">Analytics</button>
          </div>
        `;
        cardsList.appendChild(el);
      });

      // Render summary cards
      summaryCards.innerHTML = `
        <div class="sum-card"><span class="icon">üíå</span> <span>${totalCards}</span><br>Total Cards</div>
        <div class="sum-card"><span class="icon">üëÄ</span> <span>${totalViews}</span><br>Total Views</div>
        <div class="sum-card"><span class="icon">üí¨</span> <span>${totalReplies}</span><br>Total Replies</div>
        <div class="sum-card"><span class="icon">üîê</span> <span>${usedOnce}</span><br>One-time Opened</div>
      `;
    } catch (err) {
      cardsList.innerHTML = `<div style="padding:20px; color:#d20c6c">Error: ${err.message}</div>`;
    }
  }
  loadDashboard();

  // 4. Show Analytics (Popup Modal)
  window.showAnalytics = async function(cardId) {
    // Optionally create a popup modal, or just alert for now (quick version)
    // You can later upgrade this to a fancier modal
    const doc = await db.collection('cards').doc(cardId).get();
    if (!doc.exists) return alert('Card not found!');
    const c = doc.data();
    let html = `
      <div style="font-weight:bold; font-size:1.11em;">${c.cardTitle||'(No title)'}</div>
      <div style="margin:8px 0 3px;">To: <b>${c.recipientName||''}</b></div>
      <div>Created: ${fmtDate(c.createdAt)}</div>
      <div>Views: <b>${c.views||0}</b></div>
      <div>Expiry: ${c.expiryType||'Unlimited'}</div>
      <div>Replies: ${c.replies && c.replies.length ? c.replies.length : 0}</div>
    `;
    if (c.replies && c.replies.length) {
      html += `<div style="margin-top:9px; color:#bc2175;">Replies:</div><ul>`;
      c.replies.forEach(r => {
        html += `<li><b>${r.name||'Anonymous'}:</b> ${r.text||''} <span style="color:#a1a1a1; font-size:.95em;">(${fmtDate(r.timestamp)})</span></li>`;
      });
      html += `</ul>`;
    }
    alert(html.replace(/<[^>]*>/g, '')); // Quick for now. You can replace this with a real modal.
  }
</script>
</body>
</html>
