<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Share Card Settings | HeartSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      font-family: 'Poppins', Arial, sans-serif;
      background: linear-gradient(135deg, #fff1f7 0%, #c1d8ff 100%);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .container {
      max-width: 420px;
      margin: 36px auto;
      padding: 36px 18px 30px 18px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 10px 28px rgba(180, 85, 250, 0.10), 0 2px 4px rgba(0,0,0,0.02);
      text-align: center;
      position: relative;
      z-index: 2;
    }
    h1 {
      font-size: 2em;
      color: #d54a96;
      margin-bottom: 20px;
      margin-top: 0;
    }
    .input-group { margin: 14px 0 20px 0; text-align: left; }
    label { font-weight: 500; color: #565; }
    input[type="text"], input[type="password"], input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 1em;
      border-radius: 9px;
      border: 1px solid #e6dbe5;
      margin-top: 6px;
      margin-bottom: 7px;
      box-sizing: border-box;
    }
    .options-row { display: flex; flex-wrap: wrap; gap: 14px; margin-top: 8px; }
    .options-row label { flex: 1; }
    .btn {
      padding: 13px 0;
      font-size: 1.12em;
      width: 100%;
      border: none;
      border-radius: 14px;
      margin-top: 22px;
      background: linear-gradient(90deg, #ea81c4 60%, #7eb8fc 100%);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #eadcf8;
    }
    .btn:hover { background: linear-gradient(90deg, #d26fa7 60%, #53a3ee 100%); }
    .footer-btns {
      margin-top: 36px;
      display: flex;
      justify-content: space-between;
      gap: 14px;
    }
    .footer-btns .btn { width: 48%; margin-top: 0; }
    .share-link-box {
      margin-top: 30px;
      background: #f6f4fa;
      padding: 18px 8px 10px 8px;
      border-radius: 15px;
      text-align: center;
    }
    .share-link-input {
      width: 90%;
      font-size: 0.98em;
      border: 1px solid #ccc;
      padding: 7px 12px;
      border-radius: 7px;
      margin-bottom: 9px;
      background: #f8fafc;
      color: #8a43ac;
    }
    .qrcode-canvas { margin: 0 auto; margin-bottom: 6px; }
    .no-card { text-align: center; font-size: 1.1em; margin: 48px 0 10px 0; color: #ce3781; }
    /* Heart floating animation (optional, add hearts if you want) */
    .floating-hearts {
      pointer-events: none;
      position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 0;
    }
    .floating-hearts span {
      position: absolute; font-size: 24px; opacity: 0.24; animation: floatup 12s linear infinite;
    }
    @keyframes floatup {
      0% { transform: translateY(100vh) scale(1); opacity: 0.24;}
      100% { transform: translateY(-80vh) scale(1.25); opacity: 0;}
    }
  </style>
</head>
<body>
  <div class="floating-hearts" id="floatingHearts"></div>
  <div class="container" id="mainContent" style="display:none;">
    <img src="img/logo.png" alt="HeartSpeak Logo" style="width:60px; border-radius:16px; box-shadow:0 2px 14px #eedbf7;">
    <h1>Share Card Settings</h1>
    <form id="shareSettingsForm">
      <div class="input-group">
        <label><b>Privacy</b></label>
        <div class="options-row">
          <label><input type="radio" name="privacy" value="public" checked> Anyone with link</label>
          <label><input type="radio" name="privacy" value="private"> Private (require code/email/number)</label>
        </div>
        <label style="font-weight:400;"><input type="checkbox" id="setPassword"> Set password to open card (optional)</label>
        <input type="password" id="passwordInput" placeholder="Enter password" style="display:none;"/>
      </div>
      <div class="input-group">
        <label><b>Expiry &amp; Usage</b></label>
        <div class="options-row">
          <label><input type="radio" name="expiryType" value="noexpiry" checked> No expiry</label>
          <label><input type="radio" name="expiryType" value="onetime"> One-time view</label>
        </div>
        <div class="options-row">
          <label><input type="radio" name="expiryType" value="days"> Expire after days</label>
          <input type="number" id="expiryDays" min="1" placeholder="Days" style="width: 75px;">
          <label><input type="radio" name="expiryType" value="date"> Expire on date</label>
          <input type="date" id="expiryDate" style="width: 130px;">
        </div>
      </div>
      <div class="input-group">
        <label><b>Maximum Opens (optional)</b></label>
        <input type="number" id="maxOpensInput" min="1" placeholder="e.g. 5">
      </div>
      <div class="input-group">
        <label><input type="checkbox" id="allowReply" checked> Allow receiver to reply (1 reply only)</label>
      </div>
      <button type="button" id="generateLinkBtn" class="btn">Generate Link</button>
      <div id="loader" style="display:none;margin-top:15px;color:#a83ca2;">Saving &amp; generating link...</div>
      <div class="share-link-box" id="shareBox" style="display:none;">
        <div style="margin-bottom:6px;"><b>Share this link:</b></div>
        <input type="text" readonly class="share-link-input" id="cardLinkInput">
        <div id="qrcode" class="qrcode-canvas"></div>
        <button type="button" class="btn" style="background:#fff;color:#8d35d1;border:1px solid #e4cdf6;width:96%;margin-top:8px;" onclick="copyCardLink()">Copy Link</button>
      </div>
    </form>
    <div class="footer-btns">
      <button type="button" class="btn" style="background:#efbae4;color:#754091;" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
      <button type="button" class="btn" style="background:#b9dafe;color:#3965b6;" onclick="window.location.href='card-creator.html'">Create New Card</button>
    </div>
  </div>
  <div class="no-card" id="noCardMsg" style="display:none;">
    No card selected. Please go back to preview.
  </div>

  <!-- Firebase & QRCode libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qr.min.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.firebasestorage.app",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7",
      measurementId: "G-RGVFVSSPMG"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Add floating hearts animation
    window.addEventListener('DOMContentLoaded', () => {
      let hearts = "";
      for(let i=0;i<13;i++) {
        const l = Math.random()*90+2, t = Math.random()*80+8, s = Math.random()*1.4+0.5, d = Math.random()*6;
        hearts += `<span style="left:${l}vw; top:${t}vh; font-size:${18+s*14}px; animation-delay:${d}s;">ðŸ’•</span>`;
      }
      document.getElementById("floatingHearts").innerHTML = hearts;
    });
// PART 2: put this right after the end of Part 1's script tag

    // --- LOGIN SESSION CHECK --- //
    let user = null;
    let cardId = null;
    auth.onAuthStateChanged(async function(currentUser) {
      user = currentUser;
      if (!user) {
        // Not logged in, redirect
        window.location.href = "login.html";
        return;
      }
      // Check cardId from URL query
      const params = new URLSearchParams(window.location.search);
      cardId = params.get("cardid");
      if (!cardId) {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("noCardMsg").style.display = "block";
        return;
      }
      document.getElementById("mainContent").style.display = "block";
      document.getElementById("noCardMsg").style.display = "none";
    });

    // --- SET PASSWORD TOGGLE --- //
    document.getElementById("setPassword").onchange = function() {
      document.getElementById("passwordInput").style.display = this.checked ? "block" : "none";
    };

    // --- GENERATE LINK + SAVE SETTINGS --- //
    document.getElementById("generateLinkBtn").onclick = async function(e) {
      e.preventDefault();
      if (!user || !cardId) return;
      // Show loader
      document.getElementById("loader").style.display = "block";
      // Gather values
      const privacy = document.querySelector('input[name="privacy"]:checked').value;
      const setPassword = document.getElementById("setPassword").checked;
      const password = setPassword ? document.getElementById("passwordInput").value.trim() : null;
      const expiryType = document.querySelector('input[name="expiryType"]:checked').value;
      const expiryDays = document.getElementById("expiryDays").value;
      const expiryDate = document.getElementById("expiryDate").value;
      const maxOpens = document.getElementById("maxOpensInput").value;
      const allowReply = document.getElementById("allowReply").checked;

      // Format settings
      let settings = {
        privacy,
        password: setPassword && password ? password : null,
        expiryType,
        expiryDays: expiryType === "days" && expiryDays ? parseInt(expiryDays) : null,
        expiryDate: expiryType === "date" && expiryDate ? expiryDate : null,
        maxOpens: maxOpens ? parseInt(maxOpens) : null,
        allowReply
      };

      // Save to Firestore under the card document
      await db.collection("cards").doc(cardId).update({
        sharing: settings
      });

      // Create the shareable link (with cardid param)
      const link = `${window.location.origin}/receiver.html?cardid=${cardId}`;

      // Show share box
      document.getElementById("shareBox").style.display = "block";
      document.getElementById("cardLinkInput").value = link;

      // Show QR code (premium style)
      var qr = new QRious({
        element: document.getElementById('qrcode'),
        value: link,
        size: 140,
        background: '#fff',
        foreground: '#a73fa8',
        level: 'H'
      });

      // Hide loader
      document.getElementById("loader").style.display = "none";
    };

    // --- COPY LINK FUNCTION --- //
    window.copyCardLink = function() {
      const linkInput = document.getElementById("cardLinkInput");
      linkInput.select();
      document.execCommand("copy");
      alert("Card link copied!");
    };
  </script>
</body>
</html>
