<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Share Card Settings | HeartSpeak</title>
  <!-- Premium Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Poppins', 'Montserrat', Arial, sans-serif;
      background: linear-gradient(135deg, #ffd1eb 0%, #e3eaff 100%);
      overflow-x: hidden;
      position: relative;
    }
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- QRCodeJS (the correct one!) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAZAgVaMTM5BMUMSoNbbw31gFbcwXzseGU",
      authDomain: "heartspeak-bf703.firebaseapp.com",
      projectId: "heartspeak-bf703",
      storageBucket: "heartspeak-bf703.firebasestorage.app",
      messagingSenderId: "341260618790",
      appId: "1:341260618790:web:f60536bac144fb815aaae7",
      measurementId: "G-RGVFVSSPMG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    /* Floating hearts animation */
    .heart-anim {
      position: absolute;
      pointer-events: none;
      opacity: 0.15;
      animation: floatUp 8s linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(0.8);}
      100% { transform: translateY(-10vh) scale(1);}
    }
    .center-box {
      max-width: 410px;
      margin: 52px auto 0 auto;
      background: rgba(255,255,255,0.82);
      border-radius: 32px;
      box-shadow: 0 6px 38px 0 rgba(190,70,160,0.09), 0 1.5px 9px 0 rgba(80,60,160,0.05);
      padding: 36px 28px 32px 28px;
      text-align: center;
      position: relative;
      z-index: 2;
    }
    .logo-img {
      width: 74px;
      margin-bottom: 10px;
      border-radius: 1.2rem;
      box-shadow: 0 4px 20px #f0e6f8b9;
    }
    h2 {
      font-family: 'Montserrat', 'Poppins', Arial, sans-serif;
      color: #d251a4;
      font-size: 2.1em;
      font-weight: 700;
      margin: 0 0 22px 0;
      letter-spacing: 1px;
    }
    .card-preview {
      background: rgba(248,244,255,0.99);
      box-shadow: 0 0 20px #dcb7f526;
      border-radius: 24px;
      padding: 20px 16px 16px 16px;
      margin: 0 auto 28px auto;
      width: 95%;
      max-width: 330px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card-img-circle {
      width: 82px; height: 82px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 13px;
      box-shadow: 0 2px 12px #b4aad633;
      border: 4px solid #faf4fa;
    }
    .recipient-name {
      font-size: 1.19em;
      color: #a45fd9;
      font-family: 'Montserrat', 'Poppins', Arial, sans-serif;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .card-title {
      color: #f35ca6;
      font-size: 1.08em;
      font-weight: 600;
      margin-bottom: 7px;
      letter-spacing: 1.1px;
    }
    .stickers-row {
      font-size: 1.36em;
      margin-bottom: 5px;
    }
    /* Settings */
    .settings-form label {
      font-size: 1.02em;
      color: #a041c9;
      font-weight: 600;
      margin-top: 9px;
      margin-bottom: 4px;
      display: block;
      text-align: left;
    }
    .settings-form .opt-group {
      background: #fff;
      padding: 12px 18px 9px 18px;
      border-radius: 18px;
      margin-bottom: 18px;
      box-shadow: 0 1px 7px #e3c6ee2c;
      text-align: left;
    }
    .settings-form .radio-row,
    .settings-form .check-row {
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-form input[type="radio"],
    .settings-form input[type="checkbox"] {
      accent-color: #da5a9a;
      width: 18px; height: 18px;
    }
    .settings-form input[type="text"], .settings-form input[type="date"] {
      font-size: 1em;
      width: 96%;
      border: 1px solid #e3c8ed;
      border-radius: 8px;
      padding: 8px 10px;
      margin-top: 4px;
      margin-bottom: 7px;
      outline: none;
    }
    .btn-row {
      display: flex; gap: 11px; margin-top: 21px; justify-content: center;
      flex-wrap: wrap;
    }
    .btn-main {
      background: linear-gradient(90deg,#e979c7,#95c8ff);
      color: white;
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 1.15em;
      padding: 12px 38px;
      border: none;
      border-radius: 22px;
      cursor: pointer;
      font-weight: 700;
      margin-bottom: 10px;
      transition: background 0.16s;
      box-shadow: 0 1.2px 8px #c993e740;
    }
    .btn-main:disabled {
      background: #efd1e7;
      color: #bbb;
      cursor: not-allowed;
    }
    .btn-sec {
      background: linear-gradient(90deg,#efefef 10%,#e8e0f5 90%);
      color: #b463bd;
      border: none;
      border-radius: 17px;
      padding: 10px 22px;
      font-size: 1em;
      font-weight: 600;
      margin-top: 6px;
      box-shadow: 0 1px 6px #c4a4e22e;
      cursor: pointer;
      margin-right: 7px;
      margin-left: 7px;
      transition: box-shadow 0.17s;
    }
    .btn-sec:active { box-shadow: 0 1px 13px #b47ee626;}
    /* QR code */
    .qrcode-wrap {
      margin: 0 auto 15px auto;
      width: 134px; height: 134px;
      background: rgba(255,255,255,0.99);
      border-radius: 16px;
      box-shadow: 0 2px 10px #e9bbf92a;
      display: flex; align-items: center; justify-content: center;
      border: 2.5px solid #eed7fb;
    }
    @media (max-width: 650px) {
      .center-box { margin: 14vw 0 0 0; padding: 7vw 2vw 8vw 2vw; }
      .logo-img { width: 59px; }
      .card-preview { padding: 13px 4vw 12px 4vw;}
    }
  </style>
</head>
<body>
  <!-- Floating hearts -->
  <img src="https://img.icons8.com/color/48/like--v1.png" class="heart-anim" style="left:10vw;animation-delay:0s;width:38px;">
  <img src="https://img.icons8.com/color/48/like--v1.png" class="heart-anim" style="left:60vw;animation-delay:1.2s;width:31px;">
  <img src="https://img.icons8.com/color/48/like--v1.png" class="heart-anim" style="left:85vw;animation-delay:2.6s;width:28px;">
  <img src="https://img.icons8.com/color/48/like--v1.png" class="heart-anim" style="left:33vw;animation-delay:4.1s;width:42px;">
  <img src="https://img.icons8.com/color/48/like--v1.png" class="heart-anim" style="left:78vw;animation-delay:5.7s;width:34px;">
  
  <div class="center-box" id="mainBox" style="display:none;">
    <img src="img/logo.png" alt="HeartSpeak Logo" class="logo-img">
    <h2>Share Your Card</h2>
    <!-- No Card Selected Box -->
    <div id="noCardBox" style="display:none;margin:40px auto;">
      <div style="background:rgba(245,235,255,0.98);padding:35px 14px;border-radius:17px;box-shadow:0 1.5px 13px #d3a8ea19;">
        <div style="font-size:1.25em;color:#a06bcb;font-weight:600;margin-bottom:12px;">
          No card selected.
        </div>
        <div style="color:#be559a;font-size:1em;">Please go back to Preview and choose a card to continue.</div>
        <div style="margin-top:23px;">
          <button class="btn-sec" onclick="window.location.href='preview.html'">Back to Preview</button>
        </div>
      </div>
    </div>
    <!-- Card Preview & Sharing Options -->
    <div id="cardSettings" style="display:none;">
      <div class="card-preview" id="miniCard"></div>
      <form class="settings-form" id="settingsForm" autocomplete="off">
        <div class="opt-group">
          <label>Privacy</label>
          <div class="radio-row"><input type="radio" name="privacy" value="public" checked>Anyone with link</div>
          <div class="radio-row"><input type="radio" name="privacy" value="private">Private (require code/email/number)</div>
          <div class="check-row"><input type="checkbox" id="passwordEnable"><label for="passwordEnable" style="margin:0;font-weight:400;">Set password to open card (optional)</label></div>
          <input type="text" id="passwordInput" placeholder="Enter password (optional)" style="display:none;">
        </div>
        <div class="opt-group">
          <label>Expiry & Usage</label>
          <div class="radio-row"><input type="radio" name="expiry" value="no-expiry" checked>No expiry</div>
          <div class="radio-row"><input type="radio" name="expiry" value="one-time">One-time view</div>
          <div class="radio-row"><input type="radio" name="expiry" value="days"><span>Expire after days</span>
            <input type="text" id="daysInput" style="width:55px;" pattern="\d*" placeholder="e.g. 2">
          </div>
          <div class="radio-row"><input type="radio" name="expiry" value="date"><span>Expire on date</span>
            <input type="date" id="dateInput" style="width:130px;">
          </div>
        </div>
        <div class="opt-group">
          <label>Maximum Opens (optional)</label>
          <input type="text" id="maxOpensInput" placeholder="e.g. 5" pattern="\d*">
        </div>
        <div class="opt-group check-row">
          <input type="checkbox" id="allowReply" checked>
          <label for="allowReply" style="margin:0;">Allow receiver to reply (1 reply only)</label>
        </div>
        <div class="btn-row">
          <button type="button" class="btn-main" id="generateBtn">Generate Link</button>
        </div>
        <div id="qrBox" style="display:none;margin-bottom:8px;">
          <div class="qrcode-wrap" id="qrcode"></div>
          <div style="margin-top:9px;">
            <input type="text" id="cardLink" readonly style="width:92%;font-size:0.99em;text-align:center;padding:8px 5px;border-radius:8px;border:1px solid #f1bfe4;margin-bottom:6px;">
            <button type="button" class="btn-sec" onclick="copyCardLink()">Copy Link</button>
          </div>
        </div>
      </form>
      <div class="btn-row">
        <button class="btn-sec" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
        <button class="btn-sec" onclick="window.location.href='card-creator.html'">Create New Card</button>
      </div>
    </div>
  </div>



    // --- Helper Functions ---
    function getCardIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }
    function copyCardLink() {
      let input = document.getElementById('cardLink');
      input.select();
      input.setSelectionRange(0, 99999); // mobile
      document.execCommand("copy");
      alert("Link copied!");
    }
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('passwordEnable').addEventListener('change', function() {
        document.getElementById('passwordInput').style.display = this.checked ? 'block' : 'none';
      });
      let expiryRadios = document.getElementsByName('expiry');
      function updateExpiryInputs() {
        document.getElementById('daysInput').style.display =
          document.querySelector('input[name="expiry"]:checked').value === "days" ? "inline-block" : "none";
        document.getElementById('dateInput').style.display =
          document.querySelector('input[name="expiry"]:checked').value === "date" ? "inline-block" : "none";
      }
      for (let radio of expiryRadios) {
        radio.addEventListener('change', updateExpiryInputs);
      }
      updateExpiryInputs();
    });

    // --- Main Logic ---
    auth.onAuthStateChanged(async function(user) {
      document.getElementById("mainBox").style.display = "block";
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const cardId = getCardIdFromUrl();
      if (!cardId) {
        document.getElementById("noCardBox").style.display = "block";
        document.getElementById("cardSettings").style.display = "none";
        return;
      }
      const cardDoc = await db.collection("cards").doc(cardId).get();
      if (!cardDoc.exists) {
        document.getElementById("noCardBox").style.display = "block";
        document.getElementById("cardSettings").style.display = "none";
        return;
      }
      const card = cardDoc.data();
      // Render Card Preview
      const stickers = card.stickers && card.stickers.length ? card.stickers.map(s=>`<span>${s}</span>`).join(' ') : '';
      document.getElementById("miniCard").innerHTML = `
        <img class="card-img-circle" src="${card.photoURL || 'img/logo.png'}" alt="Profile">
        <div class="recipient-name">${card.recipientName ? card.recipientName.toUpperCase() : ''}</div>
        <div class="card-title">${card.cardTitle ? card.cardTitle.toUpperCase() : ''}</div>
        <div class="stickers-row">${stickers}</div>
      `;
      document.getElementById("cardSettings").style.display = "block";

      // Generate Link & QR
      document.getElementById("generateBtn").onclick = async function() {
        // Gather sharing options
        let privacy = document.querySelector('input[name="privacy"]:checked').value;
        let password = document.getElementById('passwordEnable').checked ? document.getElementById('passwordInput').value.trim() : '';
        let expiryType = document.querySelector('input[name="expiry"]:checked').value;
        let expiryDays = document.getElementById('daysInput').value.trim();
        let expiryDate = document.getElementById('dateInput').value;
        let maxOpens = document.getElementById('maxOpensInput').value.trim();
        let allowReply = document.getElementById('allowReply').checked;

        let settings = {
    
// Save sharing settings in Firestore under the card document
await db.collection("cards").doc(cardId).update({
  sharing: settings
});

// Create shareable link
let shareLink = `${window.location.origin}/receiver.html?id=${cardId}`;
document.getElementById("card-link").value = shareLink;

// Show QR code (make sure to include a <canvas id="qrcode"></canvas> in your HTML)
document.getElementById("qrBox").style.display = "block";
let qr = new QRious({
  element: document.getElementById("qrcode"),
  value: shareLink,
  size: 140,
  background: "#fff",
  foreground: "#d251a4",
  level: "H"
});
});
});
</script>
</body>
</html>
